# /home/tofu/.config/containers/containers.conf (or /etc/containers/containers.conf for system-wide, but prefer user-specific for rootless)
# Best practice configuration for rootless podman-in-podman (nested rootless setup).
# Key decisions:
# - Use host namespaces for simplicity in nested environments (avoids isolation conflicts).
# - Disable cgroups in containers.conf to align with rootless limitations (cgroupfs manager in engine).
# - Set log_driver and events_logger to "journald" for integration with systemd-journald, enabling persistence and visibility.
#   - This routes all container logs/events to journald, which can be configured for persistent storage (/var/log/journal).
#   - For host persistence: Mount container's /var/log/journal to host dir (e.g., via podman run -v ./container-logs:/var/log/journal:Z).
#   - Journald best practice: Configure /etc/systemd/journald.conf.d/persist.conf with Storage=persistent for disk storage.
# - Use crun as runtime for better rootless support and performance.
# - Short-name mode set to "strict" for security (requires explicit registries.conf with search registries).
# - Storage driver: overlay for efficiency; configure storage.conf separately if needed (e.g., for rootless graphroot).

[containers]
netns = "host"          # Share host network for nested simplicity
userns = "host"         # Share user namespace (critical for rootless nesting)
ipcns = "host"          # Share IPC
utsns = "host"          # Share UTS
cgroupns = "host"       # Share cgroup namespace
cgroups = "disabled"    # Disable in nested rootless to avoid delegation issues
log_driver = "journald" # Best practice: Log to journald for persistence/integration
log_size_max = -1       # Unlimited log size (or set to e.g., 10M)
default_sysctls = []    # Customize if needed
volumes = [
    "/proc:/proc",      # From home-containers.conf; add more as needed
]

[engine]
cgroup_manager = "cgroupfs"  # For rootless; use systemd if delegation is fully set up
events_logger = "journald"   # Persist events to journald (best for visibility)
runtime = "crun"             # Efficient for rootless
short_name_mode = "strict"   # Security: Require qualified names or aliases
healthcheck_events=false
network_cmd_path = "/usr/bin/slirp4netns"
network_backend = "netavark"
netns = "slirp4netns"  # Explicitly set to avoid pasta

# Additional best practices:
# - For nested rootless, ensure /etc/subuid and /etc/subgid have sufficient ranges (e.g., tofu:10000:65536).
# - Mount host logs: In outer podman run, use -v $PWD/container-logs:/var/log/journal:Z,rw.
# - Validate: Run 'podman info' as user; check journals with 'journalctl --user -u podman'.
# - If using storage.conf, set graphroot to user dir (e.g., /home/tofu/.local/share/containers/storage).
