# /home/tofu/.config/containers/storage.conf
# Best practice configuration for rootless Podman-in-Podman (nested rootless setup).
# Key decisions:
# - Use overlay as the storage driver for efficiency and compatibility in rootless environments.
# - Set graphroot to a user-specific directory to avoid system-wide paths and permission issues.
# - Set runroot to a runtime directory under XDG_RUNTIME_DIR for temporary state (e.g., locks, mounts).
# - Enable features like ignore_chown_errors for nested rootless to handle UID/GID mapping limitations.
# - Use fuse-overlayfs as mount_program if native overlay is unavailable (common in some nested setups).
# - Limit storage size and configure additional mounts if needed for persistence/security.
# - For host persistence: Mount the graphroot directory to the host (e.g., via outer podman run -v ./host-storage:/home/tofu/.local/share/containers/storage:Z).
# - Validate: Run 'podman info' as the user; ensure graphRoot points to the user dir.

[storage]
# Storage driver: overlay is preferred for rootless performance; fallback to vfs if overlay not supported.
driver = "overlay"

# Root directory for all container content (images, layers, containers). Use user home for rootless isolation.
graphroot = "/home/tofu/.local/share/containers/storage"

# Runtime state directory (e.g., for mounts, locks). Use XDG_RUNTIME_DIR-based path for ephemerality.
runroot = "/run/user/1001/containers"

[storage.options]
# Additional options for the storage driver.
# Size limit for the storage (e.g., 10GB; set to "" for unlimited).
size = ""

# Ignore chown errors in nested rootless setups (helps with UID/GID mapping overflows).
ignore_chown_errors = "true"

# Mount program for overlay (use fuse-overlayfs for better rootless support if native overlay fails).
mount_program = "/usr/bin/fuse-overlayfs"

# Optional: Additional mount options for overlay (e.g., for performance tuning).
mountopt = "nodev,metacopy=on"

# Skip mount home checks in rootless mode (useful for nested environments).
skip_mount_home = "true"

# Additional best practices:
# - Ensure /etc/subuid and /etc/subgid have sufficient ranges for the tofu user (e.g., tofu:10001:30000).
# - For nested volumes: Mount host dirs into the outer container to persist inner storage.
# - If switching drivers (e.g., to vfs for simplicity): Set driver = "vfs" and remove overlay-specific options.
# - Monitor with 'podman info --debug' to verify storage setup.
